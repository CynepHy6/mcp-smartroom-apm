# MCP APM Server

–°–µ—Ä–≤–µ—Ä MCP (Model Context Protocol) –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –∫ APM –ª–æ–≥–∞–º Skyeng Platform —á–µ—Ä–µ–∑ Elasticsearch API —Å –ø—Ä–æ–¥–≤–∏–Ω—É—Ç–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –¥–∞–Ω–Ω—ã—Ö.

## üöÄ –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

### üìä –ê–Ω–∞–ª–∏–∑ –¥–∞–Ω–Ω—ã—Ö
- üîç **–ü–æ–∏—Å–∫ –ª–æ–≥–æ–≤** –ø–æ –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω—ã–º —Ñ–∏–ª—å—Ç—Ä–∞–º —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –æ—á–∏—Å—Ç–∫–æ–π –¥–∞–Ω–Ω—ã—Ö
- üìã **–°—Ö–µ–º–∞ –ø–æ–ª–µ–π** –∏ —Å–æ–±—ã—Ç–∏–π –∏–Ω–¥–µ–∫—Å–æ–≤ (–∏–∑ index.yaml)
- üéØ **–ê–ª–∏–∞—Å—ã –ø–æ–ª–µ–π** - —É–ø—Ä–æ—â–µ–Ω–Ω—ã–µ –Ω–∞–∑–≤–∞–Ω–∏—è –¥–ª—è —Å–ª–æ–∂–Ω—ã—Ö –ø—É—Ç–µ–π
- üì¶ **–ü–∞—Ä—Å–∏–Ω–≥ –º–∞—Å—Å–∏–≤–æ–≤** - –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ –º–∞—Å—Å–∏–≤–æ–≤ —Å —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–æ–º `field[].subfield`
- üßπ **–û—á–∏—Å—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö** - –∫–æ–º–ø–∞–∫—Ç–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã —Ç–æ–ª—å–∫–æ —Å –Ω—É–∂–Ω—ã–º–∏ –ø–æ–ª—è–º–∏


## üõ† MCP –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã

### 1. `list_indexes` - –°–ø–∏—Å–æ–∫ –∏–Ω–¥–µ–∫—Å–æ–≤
–ü–æ–ª—É—á–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∏–Ω–¥–µ–∫—Å–æ–≤ –∏ –∏—Ö —Å—Ö–µ–º—É –ø–æ–ª–µ–π —Å –∞–ª–∏–∞—Å–∞–º–∏.

**–ü—Ä–∏–º–µ—Ä –æ—Ç–≤–µ—Ç–∞:**
```json
[
  {
    "name": "logs_videocall",
    "fields": {
      "issueReason": {
        "original_name": "details.issues[].reason",
        "description": "–ü—Ä–∏—á–∏–Ω–∞ –ø—Ä–æ–±–ª–µ–º—ã",
        "alias": "issueReason",
        "need_dedupe": true
      },
      "mos": {
        "original_name": "details.summary.publisher.publisherMos.mos",
        "description": "–ú–û–°",
        "alias": "mos"
      }
    },
    "events": [
      {"tech-summary-minute": "–æ—Ç—á–µ—Ç –ø–æ –ú–û–° –∑–∞ –º–∏–Ω—É—Ç—É"},
      {"webrtcIssue": "–ø—Ä–æ–±–ª–µ–º—ã —Å WebRTC, –∞—É–¥–∏–æ, –≤–∏–¥–µ–æ, —Å–∫—Ä–∏–Ω—à–µ—Ä–∏–Ω–≥"}
    ]
  }
]
```

### 2. `query_index` - –ü–æ–∏—Å–∫ –¥–∞–Ω–Ω—ã—Ö
–í—ã–ø–æ–ª–Ω—è–µ—Ç –ø–æ–∏—Å–∫ —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –∏ –æ—á–∏—Å—Ç–∫–æ–π –¥–∞–Ω–Ω—ã—Ö.

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- `index` - –∏–º—è –∏–Ω–¥–µ–∫—Å–∞
- `filters` - —Ñ–∏–ª—å—Ç—Ä—ã –∑–∞–ø—Ä–æ—Å–∞ (term/range/bool)
- `size` - —Ä–∞–∑–º–µ—Ä –≤—ã–±–æ—Ä–∫–∏ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 100)
- `from_` - —Å–º–µ—â–µ–Ω–∏–µ –¥–ª—è –ø–∞–≥–∏–Ω–∞—Ü–∏–∏
- `sort` - —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞

**–ü—Ä–∏–º–µ—Ä –∑–∞–ø—Ä–æ—Å–∞:**
```json
{
  "index": "logs_videocall",
  "filters": {
    "bool": {
      "must": [
        {"term": {"event": "webrtcIssue"}},
        {"term": {"appSessionId": "hofexozakone"}}
      ]
    }
  },
  "size": 10,
  "sort": [{"@timestamp": {"order": "desc"}}]
}
```

**–ü—Ä–∏–º–µ—Ä –æ—á–∏—â–µ–Ω–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞:**
```json
{
  "hits": {
    "hits": [
      {
        "_source": {
          "@timestamp": "2025-06-12T10:48:50.793950442Z",
          "userId": 5614788,
          "userRole": "admin",
          "event": "webrtcIssue",
          "appSessionId": "hofexozakone",
          "issueReason": "inbound-network-quality"
        }
      }
    ]
  }
}
```


### 4. `get_data_retention_info` - –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –¥–∞–Ω–Ω—ã—Ö
–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã–π –ø–µ—Ä–∏–æ–¥ –¥–∞–Ω–Ω—ã—Ö (–ª–æ–≥–∏ —Ö—Ä–∞–Ω—è—Ç—Å—è 20 –¥–Ω–µ–π).

## üéØ –ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

### –ü–∞—Ä—Å–∏–Ω–≥ –º–∞—Å—Å–∏–≤–æ–≤
–°–∏—Å—Ç–µ–º–∞ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ –º–∞—Å—Å–∏–≤–æ–≤:

```yaml
# index.yaml
"details.issues[].reason":     # –ò–∑–≤–ª–µ–∫–∞–µ—Ç reason –∏–∑ –≤—Å–µ—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –º–∞—Å—Å–∏–≤–∞ issues
  alias: issueReason
  need_dedupe: true

"details.issues[0].reason":    # –ò–∑–≤–ª–µ–∫–∞–µ—Ç reason –∏–∑ –ø–µ—Ä–≤–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞
  alias: firstIssueReason
```

### –ê–ª–∏–∞—Å—ã –∏ –æ—á–∏—Å—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö
- **–î–æ –æ–±—Ä–∞–±–æ—Ç–∫–∏**: ~2000+ —Å–∏–º–≤–æ–ª–æ–≤ —Å –¥–µ—Å—è—Ç–∫–∞–º–∏ –ø–æ–ª–µ–π
- **–ü–æ—Å–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏**: ~200 —Å–∏–º–≤–æ–ª–æ–≤ —Ç–æ–ª—å–∫–æ —Å –Ω—É–∂–Ω—ã–º–∏ –ø–æ–ª—è–º–∏
- **–°–æ–∫—Ä–∞—â–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞**: –≤ 10+ —Ä–∞–∑

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è
```json
// –ò—Å—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
"details.issues": [
  {"reason": "network-issue"},
  {"reason": "server-issue"},
  {"reason": "network-issue"}
]

// –†–µ–∑—É–ª—å—Ç–∞—Ç
"issueReason": "network-issue, server-issue"
```

## üìà –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### –ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–±–ª–µ–º WebRTC
```python
# –ü–æ–∏—Å–∫ –ø—Ä–æ–±–ª–µ–º –≤ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –∫–æ–º–Ω–∞—Ç–µ
query_index(
  index="logs_videocall",
  filters={"bool": {"must": [
    {"term": {"event": "webrtcIssue"}},
    {"term": {"appSessionId": "room123"}}
  ]}},
  size=50
)

# –†–µ–∑—É–ª—å—Ç–∞—Ç: –∫–æ–º–ø–∞–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Å –∞–ª–∏–∞—Å–æ–º issueReason
```

### –ê–Ω–∞–ª–∏–∑ –∫–∞—á–µ—Å—Ç–≤–∞ —Å–≤—è–∑–∏ (–ú–û–°)
```python
# –ü–æ–∏—Å–∫ –¥–∞–Ω–Ω—ã—Ö –ú–û–°
query_index(
  index="logs_videocall",
  filters={"term": {"event": "tech-summary-minute"}},
  size=100
)

# –†–µ–∑—É–ª—å—Ç–∞—Ç: –¥–∞–Ω–Ω—ã–µ —Å –∞–ª–∏–∞—Å–∞–º–∏ mos, avgJitter, rtt, packetsLoss
```


## üöÄ –ë—ã—Å—Ç—Ä–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞

```bash
# –ö–ª–æ–Ω–∏—Ä—É–µ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
git clone <repository-url> mcp-smartroom-apm
cd mcp-smartroom-apm

# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞
python3 setup.py    # Linux/macOS
python setup.py     # Windows
```

## ‚öôÔ∏è –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è (.env)
```bash
APM_BASE_URL=https://apm.skyeng.link # —ç—Ç–æ—Ç –∞–¥—Ä–µ—Å —Ç–æ–ª—å–∫–æ –¥–ª—è –ø—Ä–∏–º–µ—Ä–∞, —Å –Ω–∏–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –Ω–µ –±—É–¥–µ—Ç
APM_USERNAME=your_username
APM_PASSWORD=your_password
APM_TIMEOUT=30
```

### –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø–æ–ª–µ–π (index.yaml)
```yaml
logs_videocall:
  events:
    - tech-summary-minute: –æ—Ç—á–µ—Ç –ø–æ –ú–û–° –∑–∞ –º–∏–Ω—É—Ç—É
    - webrtcIssue: –ø—Ä–æ–±–ª–µ–º—ã —Å WebRTC
  fields:
    "@timestamp":
      description: "–í—Ä–µ–º—è —Å–æ–±—ã—Ç–∏—è"
    "details.issues[].reason":
      description: "–ü—Ä–∏—á–∏–Ω–∞ –ø—Ä–æ–±–ª–µ–º—ã"
      alias: issueReason
      need_dedupe: true
    "details.summary.publisher.publisherMos.mos":
      description: "–ú–û–°"
      alias: mos
```

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

```bash
# –ó–∞–ø—É—Å–∫ –≤—Å–µ—Ö —Ç–µ—Å—Ç–æ–≤
python -m pytest tests/ -v

# –¢–µ—Å—Ç—ã –ø–∞—Ä—Å–∏–Ω–≥–∞ –º–∞—Å—Å–∏–≤–æ–≤
python -m pytest tests/test_data_processing.py -k "array" -v

# –¢–µ—Å—Ç—ã –∞–ª–∏–∞—Å–æ–≤
python -m pytest tests/test_data_processing.py::TestDataProcessing::test_array_aliases -v
```

## üîß –£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –Ω–µ–ø–æ–ª–∞–¥–æ–∫

- **401** ‚Äî –æ—à–∏–±–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏: –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –∫—Ä–µ–¥—ã –≤ .env
- **404** ‚Äî –∏–Ω–¥–µ–∫—Å –Ω–µ –Ω–∞–π–¥–µ–Ω: –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –≤ index.yaml –∏ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –∞–¥—Ä–µ—Å **APM_BASE_URL**
- **503** ‚Äî –æ—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è: –ø—Ä–æ–≤–µ—Ä—å—Ç–µ APM_BASE_URL
- **–ü—É—Å—Ç—ã–µ –∞–ª–∏–∞—Å—ã** ‚Äî –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—É—Ç–∏ –ø–æ–ª–µ–π –≤ index.yaml
- **–ì—Ä–∞—Ñ–∏–∫–∏ –Ω–µ —Å–æ–∑–¥–∞—é—Ç—Å—è** ‚Äî —É–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ matplotlib —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω

## üìã –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è

- Python 3.8+
- –î–æ—Å—Ç—É–ø –∫ APM Skyeng Platform

## üìÑ –õ–∏—Ü–µ–Ω–∑–∏—è

–í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç Skyeng Platform